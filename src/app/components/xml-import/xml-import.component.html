<div #top class="container">
  <div class="file-input-section">
    <div class="drop-zone" 
         (dragover)="onDragOver($event)" 
         (dragleave)="onDragLeave($event)" 
         (drop)="onFileDrop($event)">
      <mat-icon>cloud_upload</mat-icon>
      <h3>Arraste e solte arquivos XML aqui</h3>
      <p>ou</p>
      <button mat-raised-button color="primary" (click)="fileInput.click()">
        Selecionar Arquivos
      </button>
      <input #fileInput type="file" 
             (change)="onFileSelected($event)" 
             accept=".xml" 
             multiple 
             style="display: none">
    </div>
  </div>

  <div class="imported-files" *ngIf="importedFiles.length > 0">
    <mat-card *ngFor="let file of importedFiles; let i = index">
      <mat-card-header>
        <mat-card-title>
          {{file.name}}
          <button mat-icon-button color="warn" (click)="removeFile(i)" 
                  matTooltip="Remover arquivo">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="table-container">
          <div class="file-header">
            <div class="search-box">
              <mat-form-field>
                <mat-label>Pesquisar colunas</mat-label>
                <input matInput [(ngModel)]="file.columnSearchText" 
                       placeholder="Digite para filtrar...">
                <button mat-icon-button matSuffix *ngIf="file.columnSearchText" 
                        (click)="file.columnSearchText=''">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-form-field>
            </div>
            
            <mat-checkbox
              [checked]="areAllColumnsSelected(file)"
              [indeterminate]="areSomeColumnsSelected(file)"
              (change)="toggleAllColumns(file)">
              Selecionar todas as colunas desta planilha
            </mat-checkbox>
          </div>

          <table>
            <thead>
              <tr cdkDropList cdkDropListOrientation="horizontal" 
                  (cdkDropListDropped)="onColumnDrop($event, file)">
                <th *ngFor="let column of getVisibleColumns(file)" cdkDrag>
                  <div class="column-header">
                    <mat-checkbox 
                      [(ngModel)]="column.selected"
                      (ngModelChange)="toggleColumnSelection(column, file)"
                      [checked]="column.selected">
                      {{column.displayName}}
                    </mat-checkbox>
                    <mat-icon class="drag-handle">drag_indicator</mat-icon>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of file.data">
                <td *ngFor="let column of getVisibleColumns(file)" 
                    [class.large-content]="isLargeContent(row[column.key])" 
                    [class.expanded]="isExpanded(file.name, column.key, row)">
                  <div class="content-preview">
                    {{row[column.key]}}
                  </div>
                  <button *ngIf="isLargeContent(row[column.key])" 
                          class="expand-button"
                          (click)="toggleExpand(file.name, column.key, row)">
                    {{isExpanded(file.name, column.key, row) ? 'Menos' : 'Mais'}}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="fixed-buttons">
    <button mat-raised-button
            color="primary"
            class="export-button"
            (click)="exportAllToExcel()"
            [disabled]="!columnSelectionService.hasSelectedColumns()">
      <mat-icon>file_download</mat-icon>
      Exportar para Excel
    </button>
  </div>

  <button mat-fab class="back-to-top" 
          (click)="scrollToTop()" 
          *ngIf="showBackToTop">
    <mat-icon>arrow_upward</mat-icon>
  </button>
</div>