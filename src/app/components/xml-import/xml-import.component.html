<div #top class="xml-import-container">
  <div class="file-input-container">
    <div class="drop-zone large-drop-zone" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onFileDrop($event)">
      <mat-icon class="upload-icon">cloud_upload</mat-icon>
      <button mat-raised-button color="primary" (click)="fileInput.click()">
        <mat-icon>upload_file</mat-icon>
        Selecionar Arquivo XML
      </button>
      <p class="instructions">Arraste e solte arquivos XML aqui ou clique no botão acima</p>
    </div>
    <input #fileInput type="file" (change)="onFileSelected($event)" accept=".xml" multiple style="display: none">
  </div>

  <div *ngFor="let file of importedFiles; let i = index" class="file-container">
    <mat-card class="compact-card">
      <mat-card-header>
        <mat-card-title>
          {{ file.name }}
          <button mat-icon-button color="warn" (click)="removeFile(i)" matTooltip="Remover arquivo">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="controls-container">
          <div class="search-controls">
            <mat-form-field class="search-field" appearance="outline">
              <mat-label>Pesquisar colunas</mat-label>
              <input matInput [(ngModel)]="file.columnSearchText" placeholder="Digite para buscar colunas">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <div class="select-all-container">
              <mat-checkbox #selectAllCheckbox
                           [checked]="areAllColumnsSelected(file)"
                           [indeterminate]="areSomeColumnsSelected(file)"
                           (change)="$event ? toggleAllColumns($event.checked, file) : null">
                Selecionar todas as colunas desta planilha
              </mat-checkbox>
            </div>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="onColumnDrop($event, file)">
                <th *ngFor="let column of getVisibleColumns(file)" cdkDrag>
                  <div class="column-header">
                    <mat-checkbox 
                      [(ngModel)]="column.selected"
                      (change)="toggleColumnSelection(column, file)">
                      {{column.displayName}}
                    </mat-checkbox>
                    <mat-icon class="drag-handle">drag_indicator</mat-icon>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of file.data">
                <td *ngFor="let column of getVisibleColumns(file)" 
                    [class.large-content]="isLargeContent(row[column.key])" 
                    [class.expanded]="isExpanded(file.name, column.key, row)">
                  <div class="content-preview">
                    {{row[column.key]}}
                  </div>
                  <button *ngIf="isLargeContent(row[column.key])" 
                          class="expand-button"
                          (click)="toggleExpand(file.name, column.key, row)">
                    {{isExpanded(file.name, column.key, row) ? 'Menos' : 'Mais'}}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Botões fixos -->
  <div class="fixed-buttons">
    <button mat-fab 
            color="primary" 
            class="back-to-top-button"
            (click)="scrollToTop()" 
            matTooltip="Voltar ao topo"
            *ngIf="showBackToTop">
      <mat-icon>arrow_upward</mat-icon>
    </button>

    <div class="actions-container">
      <button mat-raised-button
              class="export-button"
              (click)="exportAllToExcel()"
              [disabled]="!canExport()"
              matTooltip="Exportar dados para Excel">
        <mat-icon>file_download</mat-icon>
        Exportar para Excel
      </button>
    </div>
  </div>
</div>